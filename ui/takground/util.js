"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.moveTo = exports.keysToDir = exports.computeSquareCenter = exports.createEl = exports.isRightButton = exports.eventPosition = exports.setVisible = exports.translateRel = exports.translateAbs = exports.posToTranslateRel = exports.posToTranslateAbs = exports.samePiece = exports.distanceSq = exports.opposite = exports.timer = exports.memo = exports.allPos = exports.key2pos = exports.pos2key = exports.allKeys = exports.invRanks = void 0;
const cg = require("./types");
exports.invRanks = [...cg.ranks].reverse();
exports.allKeys = Array.prototype.concat(...cg.files.map(c => cg.ranks.map(r => c + r)));
const pos2key = (pos) => exports.allKeys[8 * pos[0] + pos[1]];
exports.pos2key = pos2key;
const key2pos = (k) => [k.charCodeAt(0) - 97, k.charCodeAt(1) - 49];
exports.key2pos = key2pos;
exports.allPos = exports.allKeys.map(exports.key2pos);
function memo(f) {
    let v;
    const ret = () => {
        if (v === undefined)
            v = f();
        return v;
    };
    ret.clear = () => {
        v = undefined;
    };
    return ret;
}
exports.memo = memo;
const timer = () => {
    let startAt;
    return {
        start() {
            startAt = performance.now();
        },
        cancel() {
            startAt = undefined;
        },
        stop() {
            if (!startAt)
                return 0;
            const time = performance.now() - startAt;
            startAt = undefined;
            return time;
        },
    };
};
exports.timer = timer;
const opposite = (c) => (c === 'white' ? 'black' : 'white');
exports.opposite = opposite;
const distanceSq = (pos1, pos2) => {
    const dx = pos1[0] - pos2[0], dy = pos1[1] - pos2[1];
    return dx * dx + dy * dy;
};
exports.distanceSq = distanceSq;
const samePiece = (p1, p2) => p1.role === p2.role && p1.color === p2.color;
exports.samePiece = samePiece;
const posToTranslateBase = (pos, asWhite, xFactor, yFactor, index) => [
    (asWhite ? pos[0] : 7 - pos[0]) * xFactor,
    (asWhite ? 7 - pos[1] : pos[1]) * yFactor + (index ? index + 1 : 0) * 5,
];
const posToTranslateAbs = (bounds) => {
    const xFactor = bounds.width / 8, yFactor = bounds.height / 8;
    return (pos, asWhite, index) => posToTranslateBase(pos, asWhite, xFactor, yFactor, index);
};
exports.posToTranslateAbs = posToTranslateAbs;
const posToTranslateRel = (pos, asWhite, index) => posToTranslateBase(pos, asWhite, 100, 100, index);
exports.posToTranslateRel = posToTranslateRel;
const translateAbs = (el, pos, lifted = false) => {
    if (lifted)
        el.style.transform = `translate(${pos[0]}px,${pos[1] - 5}px)`;
    else
        el.style.transform = `translate(${pos[0]}px,${pos[1]}px)`;
};
exports.translateAbs = translateAbs;
const translateRel = (el, percents, lifted = false) => {
    if (lifted)
        el.style.transform = `translate(${percents[0]}%,${percents[1] - 0.2}%)`;
    else
        el.style.transform = `translate(${percents[0]}%,${percents[1]}%)`;
};
exports.translateRel = translateRel;
const setVisible = (el, v) => {
    el.style.visibility = v ? 'visible' : 'hidden';
};
exports.setVisible = setVisible;
const eventPosition = (e) => {
    var _a;
    if (e.clientX || e.clientX === 0)
        return [e.clientX, e.clientY];
    if ((_a = e.targetTouches) === null || _a === void 0 ? void 0 : _a[0])
        return [e.targetTouches[0].clientX, e.targetTouches[0].clientY];
    return; // touchend has no position!
};
exports.eventPosition = eventPosition;
const isRightButton = (e) => e.buttons === 2 || e.button === 2;
exports.isRightButton = isRightButton;
const createEl = (tagName, className) => {
    const el = document.createElement(tagName);
    if (className)
        el.className = className;
    return el;
};
exports.createEl = createEl;
function computeSquareCenter(key, asWhite, bounds) {
    const pos = exports.key2pos(key);
    if (!asWhite) {
        pos[0] = 7 - pos[0];
        pos[1] = 7 - pos[1];
    }
    return [
        bounds.left + (bounds.width * pos[0]) / 8 + bounds.width / 16,
        bounds.top + (bounds.height * (7 - pos[1])) / 8 + bounds.height / 16,
    ];
}
exports.computeSquareCenter = computeSquareCenter;
function keysToDir(orig, dest) {
    const fdiff = orig.charCodeAt(0) - dest.charCodeAt(0);
    const rdiff = orig.charCodeAt(1) - dest.charCodeAt(1);
    if (fdiff === 0)
        return (rdiff > 0) ? '-' : '+';
    else
        return (fdiff > 0) ? '<' : '>';
}
exports.keysToDir = keysToDir;
function moveTo(orig, dir, n = 1) {
    switch (dir) {
        case '+':
            let up = cg.ranks.findIndex(i => i == orig[1]) + n;
            if (up < cg.ranks.length)
                return `${orig[0]}${cg.ranks[up]}`;
            else
                return undefined;
        case '-':
            let down = cg.ranks.findIndex(i => i == orig[1]) - n;
            if (down >= 0)
                return `${orig[0]}${cg.ranks[down]}`;
            else
                return undefined;
        case '>':
            let right = cg.files.findIndex(i => i == orig[0]) + n;
            if (right < cg.files.length)
                return `${cg.files[right]}${orig[1]}`;
            else
                return undefined;
        case '<':
            let left = cg.files.findIndex(i => i == orig[0]) - n;
            if (left >= 0)
                return `${cg.files[left]}${orig[1]}`;
            else
                return undefined;
        default:
            return undefined;
    }
}
exports.moveTo = moveTo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNyYy91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDhCQUE4QjtBQUVqQixRQUFBLFFBQVEsR0FBdUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUV2RCxRQUFBLE9BQU8sR0FBc0IsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUUxRyxNQUFNLE9BQU8sR0FBRyxDQUFDLEdBQVcsRUFBVSxFQUFFLENBQUMsZUFBTyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFBaEUsUUFBQSxPQUFPLFdBQXlEO0FBRXRFLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBUyxFQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7QUFBOUUsUUFBQSxPQUFPLFdBQXVFO0FBRTlFLFFBQUEsTUFBTSxHQUFzQixlQUFPLENBQUMsR0FBRyxDQUFDLGVBQU8sQ0FBQyxDQUFDO0FBRTlELFNBQWdCLElBQUksQ0FBSSxDQUFVO0lBQ2hDLElBQUksQ0FBZ0IsQ0FBQztJQUNyQixNQUFNLEdBQUcsR0FBRyxHQUFNLEVBQUU7UUFDbEIsSUFBSSxDQUFDLEtBQUssU0FBUztZQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUM3QixPQUFPLENBQUMsQ0FBQztJ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LEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3JCO0lBQ0QsT0FBTztRQUNMLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxHQUFHLEVBQUU7UUFDN0QsTUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sR0FBRyxFQUFFO0tBQ3JFLENBQUM7QUFDSixDQUFDO0FBVkQsa0RBVUM7QUFFRCxTQUFnQixTQUFTLENBQUMsSUFBWSxFQUFFLElBQVk7SUFDbEQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RCxJQUFJLEtBQUssS0FBRyxDQUFDO1FBQUUsT0FBTyxDQUFDLEtBQUssR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBbUIsQ0FBQyxDQUFDLENBQUMsR0FBbUIsQ0FBQzs7UUFDdkUsT0FBTyxDQUFDLEtBQUssR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBbUIsQ0FBQyxDQUFDLENBQUMsR0FBbUIsQ0FBQztBQUNwRSxDQUFDO0FBTEQsOEJBS0M7QUFJRCxTQUFnQixNQUFNLENBQUMsSUFBWSxFQUFFLEdBQWlCLEVBQUUsSUFBWSxDQUFDO0lBQ25FLFFBQVEsR0FBRyxFQUFFO1FBQ1gsS0FBSyxHQUFHO1lBQ04sSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2xELElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTTtnQkFBRSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEVBQVksQ0FBQzs7Z0JBQ2xFLE9BQU8sU0FBUyxDQUFDO1FBQ3hCLEtBQUssR0FBRztZQUNOLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwRCxJQUFJLElBQUksSUFBSSxDQUFDO2dCQUFFLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBWSxDQUFDOztnQkFDekQsT0FBTyxTQUFTLENBQUM7UUFDeEIsS0FBSyxHQUFHO1lBQ04sSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3JELElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTTtnQkFBRSxPQUFPLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQVksQ0FBQzs7Z0JBQ3hFLE9BQU8sU0FBUyxDQUFDO1FBQ3hCLEtBQUssR0FBRztZQUNOLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwRCxJQUFJLElBQUksSUFBSSxDQUFDO2dCQUFFLE9BQU8sR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBWSxDQUFDOztnQkFDekQsT0FBTyxTQUFTLENBQUM7UUFDeEI7WUFDRSxPQUFPLFNBQVMsQ0FBQztLQUNwQjtBQUNILENBQUM7QUFyQkQsd0JBcUJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2cgZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBjb25zdCBpbnZSYW5rczogcmVhZG9ubHkgY2cuUmFua1tdID0gWy4uLmNnLnJhbmtzXS5yZXZlcnNlKCk7XG5cbmV4cG9ydCBjb25zdCBhbGxLZXlzOiByZWFkb25seSBjZy5LZXlbXSA9IEFycmF5LnByb3RvdHlwZS5jb25jYXQoLi4uY2cuZmlsZXMubWFwKGMgPT4gY2cucmFua3MubWFwKHIgPT4gYyArIHIpKSk7XG5cbmV4cG9ydCBjb25zdCBwb3Mya2V5ID0gKHBvczogY2cuUG9zKTogY2cuS2V5ID0+IGFsbEtleXNbOCAqIHBvc1swXSArIHBvc1sxXV07XG5cbmV4cG9ydCBjb25zdCBrZXkycG9zID0gKGs6IGNnLktleSk6IGNnLlBvcyA9PiBbay5jaGFyQ29kZUF0KDApIC0gOTcsIGsuY2hhckNvZGVBdCgxKSAtIDQ5XTtcblxuZXhwb3J0IGNvbnN0IGFsbFBvczogcmVhZG9ubHkgY2cuUG9zW10gPSBhbGxLZXlzLm1hcChrZXkycG9zKTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1lbW88QT4oZjogKCkgPT4gQSk6IGNnLk1lbW88QT4ge1xuICBsZXQgdjogQSB8IHVuZGVmaW5lZDtcbiAgY29uc3QgcmV0ID0gKCk6IEEgPT4ge1xuICAgIGlmICh2ID09PSB1bmRlZmluZWQpIHYgPSBmKCk7XG4gICAgcmV0dXJuIHY7XG4gIH07XG4gIHJldC5jbGVhciA9ICgpID0+IHtcbiAgICB2ID0gdW5kZWZpbmVkO1xuICB9O1xuICByZXR1cm4gcmV0O1xufVxuXG5leHBvcnQgY29uc3QgdGltZXIgPSAoKTogY2cuVGltZXIgPT4ge1xuICBsZXQgc3RhcnRBdDogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICByZXR1cm4ge1xuICAgIHN0YXJ0KCkge1xuICAgICAgc3RhcnRBdCA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIH0sXG4gICAgY2FuY2VsKCkge1xuICAgICAgc3RhcnRBdCA9IHVuZGVmaW5lZDtcbiAgICB9LFxuICAgIHN0b3AoKSB7XG4gICAgICBpZiAoIXN0YXJ0QXQpIHJldHVybiAwO1xuICAgICAgY29uc3QgdGltZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnRBdDtcbiAgICAgIHN0YXJ0QXQgPSB1bmRlZmluZWQ7XG4gICAgICByZXR1cm4gdGltZTtcbiAgICB9LFxuICB9O1xufTtcblxuZXhwb3J0IGNvbnN0IG9wcG9zaXRlID0gKGM6IGNnLkNvbG9yKTogY2cuQ29sb3IgPT4gKGMgPT09ICd3aGl0ZScgPyAnYmxhY2snIDogJ3doaXRlJyk7XG5cbmV4cG9ydCBjb25zdCBkaXN0YW5jZVNxID0gKHBvczE6IGNnLlBvcywgcG9zMjogY2cuUG9zKTogbnVtYmVyID0+IHtcbiAgY29uc3QgZHggPSBwb3MxWzBdIC0gcG9zMlswXSxcbiAgICBkeSA9IHBvczFbMV0gLSBwb3MyWzFdO1xuICByZXR1cm4gZHggKiBkeCArIGR5ICogZHk7XG59O1xuXG5leHBvcnQgY29uc3Qgc2FtZVBpZWNlID0gKHAxOiBjZy5QaWVjZSwgcDI6IGNnLlBpZWNlKTogYm9vbGVhbiA9PiBwMS5yb2xlID09PSBwMi5yb2xlICYmIHAxLmNvbG9yID09PSBwMi5jb2xvcjtcblxuY29uc3QgcG9zVG9UcmFuc2xhdGVCYXNlID0gKHBvczogY2cuUG9zLCBhc1doaXRlOiBib29sZWFuLCB4RmFjdG9yOiBudW1iZXIsIHlGYWN0b3I6IG51bWJlciwgaW5kZXg/OiBudW1iZXIpOiBjZy5OdW1iZXJQYWlyID0+IFtcbiAgKGFzV2hpdGUgPyBwb3NbMF0gOiA3IC0gcG9zWzBdKSAqIHhGYWN0b3IsXG4gIChhc1doaXRlID8gNyAtIHBvc1sxXSA6IHBvc1sxXSkgKiB5RmFjdG9yICsgKGluZGV4ID8gaW5kZXggKyAxIDogMCkgKiA1LFxuXTtcblxuZXhwb3J0IGNvbnN0IHBvc1RvVHJhbnNsYXRlQWJzID0gKGJvdW5kczogQ2xpZW50UmVjdCk6ICgocG9zOiBjZy5Qb3MsIGFzV2hpdGU6IGJvb2xlYW4sIGluZGV4PzogbnVtYmVyKSA9PiBjZy5OdW1iZXJQYWlyKSA9PiB7XG4gIGNvbnN0IHhGYWN0b3IgPSBib3VuZHMud2lkdGggLyA4LFxuICAgIHlGYWN0b3IgPSBib3VuZHMuaGVpZ2h0IC8gODtcbiAgcmV0dXJuIChwb3MsIGFzV2hpdGUsIGluZGV4KSA9PiBwb3NUb1RyYW5zbGF0ZUJhc2UocG9zLCBhc1doaXRlLCB4RmFjdG9yLCB5RmFjdG9yLCBpbmRleCk7XG59O1xuXG5leHBvcnQgY29uc3QgcG9zVG9UcmFuc2xhdGVSZWwgPSAocG9zOiBjZy5Qb3MsIGFzV2hpdGU6IGJvb2xlYW4sIGluZGV4PzogbnVtYmVyKTogY2cuTnVtYmVyUGFpciA9PlxuICBwb3NUb1RyYW5zbGF0ZUJhc2UocG9zLCBhc1doaXRlLCAxMDAsIDEwMCwgaW5kZXgpO1xuXG5leHBvcnQgY29uc3QgdHJhbnNsYXRlQWJzID0gKGVsOiBIVE1MRWxlbWVudCwgcG9zOiBjZy5OdW1iZXJQYWlyLCBsaWZ0ZWQ6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQgPT4ge1xuICBpZiAobGlmdGVkKSBlbC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7cG9zWzBdfXB4LCR7cG9zWzFdIC0gNX1weClgO1xuICBlbHNlIGVsLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtwb3NbMF19cHgsJHtwb3NbMV19cHgpYDtcbn07XG5cbmV4cG9ydCBjb25zdCB0cmFuc2xhdGVSZWwgPSAoZWw6IEhUTUxFbGVtZW50LCBwZXJjZW50czogY2cuTnVtYmVyUGFpciwgbGlmdGVkOiBib29sZWFuID0gZmFsc2UpOiB2b2lkID0+IHtcbiAgaWYgKGxpZnRlZCkgZWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke3BlcmNlbnRzWzBdfSUsJHtwZXJjZW50c1sxXSAtIDAuMn0lKWA7XG4gIGVsc2UgZWwuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgke3BlcmNlbnRzWzBdfSUsJHtwZXJjZW50c1sxXX0lKWA7XG59O1xuXG5leHBvcnQgY29uc3Qgc2V0VmlzaWJsZSA9IChlbDogSFRNTEVsZW1lbnQsIHY6IGJvb2xlYW4pOiB2b2lkID0+IHtcbiAgZWwuc3R5bGUudmlzaWJpbGl0eSA9IHYgPyAndmlzaWJsZScgOiAnaGlkZGVuJztcbn07XG5cbmV4cG9ydCBjb25zdCBldmVudFBvc2l0aW9uID0gKGU6IGNnLk1vdWNoRXZlbnQpOiBjZy5OdW1iZXJQYWlyIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKGUuY2xpZW50WCB8fCBlLmNsaWVudFggPT09IDApIHJldHVybiBbZS5jbGllbnRYLCBlLmNsaWVudFkhXTtcbiAgaWYgKGUudGFyZ2V0VG91Y2hlcz8uWzBdKSByZXR1cm4gW2UudGFyZ2V0VG91Y2hlc1swXS5jbGllbnRYLCBlLnRhcmdldFRvdWNoZXNbMF0uY2xpZW50WV07XG4gIHJldHVybjsgLy8gdG91Y2hlbmQgaGFzIG5vIHBvc2l0aW9uIVxufTtcblxuZXhwb3J0IGNvbnN0IGlzUmlnaHRCdXR0b24gPSAoZTogY2cuTW91Y2hFdmVudCk6IGJvb2xlYW4gPT4gZS5idXR0b25zID09PSAyIHx8IGUuYnV0dG9uID09PSAyO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlRWwgPSAodGFnTmFtZTogc3RyaW5nLCBjbGFzc05hbWU/OiBzdHJpbmcpOiBIVE1MRWxlbWVudCA9PiB7XG4gIGNvbnN0IGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTtcbiAgaWYgKGNsYXNzTmFtZSkgZWwuY2xhc3NOYW1lID0gY2xhc3NOYW1lO1xuICByZXR1cm4gZWw7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZVNxdWFyZUNlbnRlcihrZXk6IGNnLktleSwgYXNXaGl0ZTogYm9vbGVhbiwgYm91bmRzOiBDbGllbnRSZWN0KTogY2cuTnVtYmVyUGFpciB7XG4gIGNvbnN0IHBvcyA9IGtleTJwb3Moa2V5KTtcbiAgaWYgKCFhc1doaXRlKSB7XG4gICAgcG9zWzBdID0gNyAtIHBvc1swXTtcbiAgICBwb3NbMV0gPSA3IC0gcG9zWzFdO1xuICB9XG4gIHJldHVybiBbXG4gICAgYm91bmRzLmxlZnQgKyAoYm91bmRzLndpZHRoICogcG9zWzBdKSAvIDggKyBib3VuZHMud2lkdGggLyAxNixcbiAgICBib3VuZHMudG9wICsgKGJvdW5kcy5oZWlnaHQgKiAoNyAtIHBvc1sxXSkpIC8gOCArIGJvdW5kcy5oZWlnaHQgLyAxNixcbiAgXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGtleXNUb0RpcihvcmlnOiBjZy5LZXksIGRlc3Q6IGNnLktleSkge1xuICBjb25zdCBmZGlmZiA9IG9yaWcuY2hhckNvZGVBdCgwKSAtIGRlc3QuY2hhckNvZGVBdCgwKTtcbiAgY29uc3QgcmRpZmYgPSBvcmlnLmNoYXJDb2RlQXQoMSkgLSBkZXN0LmNoYXJDb2RlQXQoMSk7XG4gIGlmIChmZGlmZj09PTApIHJldHVybiAocmRpZmY+MCkgPyAnLScgYXMgY2cuRGlyZWN0aW9uIDogJysnIGFzIGNnLkRpcmVjdGlvbjtcbiAgZWxzZSByZXR1cm4gKGZkaWZmPjApID8gJzwnIGFzIGNnLkRpcmVjdGlvbiA6ICc+JyBhcyBjZy5EaXJlY3Rpb247XG59XG5cblxuXG5leHBvcnQgZnVuY3Rpb24gbW92ZVRvKG9yaWc6IGNnLktleSwgZGlyOiBjZy5EaXJlY3Rpb24sIG46IG51bWJlciA9IDEpOiBjZy5LZXkgfCB1bmRlZmluZWQge1xuICBzd2l0Y2ggKGRpcikge1xuICAgIGNhc2UgJysnOlxuICAgICAgbGV0IHVwID0gY2cucmFua3MuZmluZEluZGV4KCBpID0+IGk9PW9yaWdbMV0pICsgbjtcbiAgICAgIGlmICh1cCA8IGNnLnJhbmtzLmxlbmd0aCkgcmV0dXJuIGAke29yaWdbMF19JHtjZy5yYW5rc1t1cF19YCBhcyBjZy5LZXk7XG4gICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgY2FzZSAnLSc6XG4gICAgICBsZXQgZG93biA9IGNnLnJhbmtzLmZpbmRJbmRleCggaSA9PiBpPT1vcmlnWzFdKSAtIG47XG4gICAgICBpZiAoZG93biA+PSAwKSByZXR1cm4gYCR7b3JpZ1swXX0ke2NnLnJhbmtzW2Rvd25dfWAgYXMgY2cuS2V5O1xuICAgICAgZWxzZSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIGNhc2UgJz4nOlxuICAgICAgbGV0IHJpZ2h0ID0gY2cuZmlsZXMuZmluZEluZGV4KCBpID0+IGk9PW9yaWdbMF0pICsgbjtcbiAgICAgIGlmIChyaWdodCA8IGNnLmZpbGVzLmxlbmd0aCkgcmV0dXJuIGAke2NnLmZpbGVzW3JpZ2h0XX0ke29yaWdbMV19YCBhcyBjZy5LZXk7XG4gICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgY2FzZSAnPCc6XG4gICAgICBsZXQgbGVmdCA9IGNnLmZpbGVzLmZpbmRJbmRleCggaSA9PiBpPT1vcmlnWzBdKSAtIG47XG4gICAgICBpZiAobGVmdCA+PSAwKSByZXR1cm4gYCR7Y2cuZmlsZXNbbGVmdF19JHtvcmlnWzFdfWAgYXMgY2cuS2V5O1xuICAgICAgZWxzZSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG59XG4iXX0=